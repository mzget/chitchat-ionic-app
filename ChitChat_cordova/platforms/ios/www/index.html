<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
	<title></title>

	<link href="lib/ionic/css/ionic.css" rel="stylesheet" />
	<link href="css/style.css" rel="stylesheet" />

	<!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
	<link href="css/ionic.app.css" rel="stylesheet" />
	-->
	<!-- ionic/angularjs js -->
	<script src="lib/ionic/js/ionic.bundle.js"></script>

	<script src="lib/ngCordova/dist/ng-cordova.js"></script>

	<!-- cordova script (this will be a 404 during development) -->
	<script src="cordova.js"></script>

	<!-- your app's js -->
	<script src="js/app.js"></script>
	<script src="js/controllers.js"></script>
	<script src="js/services.js"></script>
	<script src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/async.js"></script>
    <script src="https://www.promisejs.org/polyfills/promise-done-7.0.4.min.js"></script>
	<script src="js/require.js" data-main="scripts/appBundle"></script>
	
	<script src="js/template.js"></script>
	
	<script src="scripts/appBundle.js"></script>

</head>
<body ng-app="starter">    
	<script src="js/socket.io.js"></script>
	<script>
		var socket = io;
		var main = Main.prototype;
		var server = ChatServer.ServerImplemented.prototype;
		var serverEvents = ChatServer.ServerEventListener.prototype;
		var dataManager = DataManager.prototype;
		main.setDataManager(dataManager);
		main.setServerListener(serverEvents);
		main.setServerImp(server);
		main.onMyProfileReadyListener = function(dataManager) {
			console.warn('goto group');
			$('#login').css('display','none');
			$('.bar-stable').css({'display':''});
			$('#splash').css({'display':'none'});
			location.href = "#/tab/group";					
		};
		server.init(function (err, server) {
		    var authen = server.authenData;
		    console.log("token: ", authen.token);
		    if (!authen.token) {
		        $('#splash').css({ 'display': 'none' });

		        $('body #login #btn-login').click(function (event) {
		            console.log('loging A');
		            event.preventDefault();
		            $('body #login input').attr('readonly', true);
		            email = $('body #login form input[name="email"]').val();
		            password = $('body #login form input[name="password"]').val();

		            main.getHashService(password, function (err, res) {
		                main.authenUser(server, email, res, function (err, res) {
		                    if (!err && res !== null) {
		                        if (res.code === 200) {
		                            console.log("Success Login User...");
		                        }
		                        else {
		                            $('body #login input').attr('readonly', false);

		                            console.error(err, res);
									onDuplicateLogin(err);
		                        }
		                    }
		                    else {
		                        $('body #login input').attr('readonly', false);

		                        console.error(err, res);
								onDuplicateLogin(err);
		                    }
		                });
		            });
		        });
		    }
		    else {
		        server.TokenAuthen(authen.token, function (err, res) {
		            if (!err && res !== null) {
		                console.log("Authen result: ", JSON.stringify(res));
		                if (res.success) {
		                    main.authenUser(server, res.username, res.password, function (err, res) {
		                        if (!err && res !== null) {
		                            if (res.code === 200) {
		                                console.log("Success Authen User...");
		                            }
		                            else {
		                                //<!-- Authen fail.
		                                server.Logout();
		                                location.href = '';

		                                console.error(err, res);
										onDuplicateLogin(err);
		                            }
		                        }
		                        else {
		                            //<!-- Authen fail.
		                            server.Logout();
		                            location.href = '';

		                            console.error(err, res);
									onDuplicateLogin(err);
		                        }
		                    });
		                }
		            }
		        });
		    }
		    });
		
			function onDuplicateLogin(errMessage) {
				navigator.notification.confirm("May be you use this app in other devices \n You want to logout other devices", function (buttonIndex) {
					switch (buttonIndex) {
						case 1:
							break;
						case 2:
							break;
					}
				}, "Duplicated login!", ["Cancle", "OK"]);
			}	
	</script>

    <ion-nav-bar class="bar-stable" style="display:none;">
        <ion-nav-back-button>
        </ion-nav-back-button>
    </ion-nav-bar>
    <ion-nav-view></ion-nav-view>
	
	 
	<div id="splash">
		<div class="container">
			<img class="login-logo" src="img/logo-main.png" width="30%" /><br /><br />
			<ion-spinner icon="spiral"></ion-spinner>
		</div>
	</div>
	
	<div id="send_message">
		<input type="text" name="send_message" />
		<button><i class="ion-share" data-pack="default" data-tags="outbound"></i></button>
	</div>

</body>
</html>
