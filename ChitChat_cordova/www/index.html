<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>React Tutorial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
</head>
<body>
    <div id="content"></div>
    <script src="js/require.js" data-main="scripts/appBundle"></script>
    <script type="text/javascript" src="scripts/appBundle.js">   </script>
    <script src="js/socket.io.js"></script>
	<script>
		var socket = io;
		var main = Main.prototype;
		var server = ChatServer.ServerImplemented.prototype;
		var serverEvents = ChatServer.ServerEventListener.prototype;
		var dataManager = DataManager.prototype;
        
        var dummy = new Dummy();
		var bot = dummy.getBot();
        
		main.setDataManager(dataManager);
		main.setServerListener(serverEvents);
		main.setServerImp(server);
		main.onMyProfileReadyListener = function(dataManager) { 
            dummy.fireChatInRoom(dataManager.myProfile._id);
		};

        
		server.init(function (err, server) {
		    var authen = server.authenData;
		    console.log("token: ", authen.token);
		    if (!authen.token) {
		        $('#splash').css({ 'display': 'none' });

		            email = bot.name;
		            password = bot.pass;

		            main.getHashService(password, function (err, res) {
		                main.authenUser(server, email, res, function (err, res) {
		                    if (!err && res !== null) {
		                        if (res.code === 200) {
		                            console.log("Success Login User...");
		                        }
		                        else if(res.code === 1004) {
		                            $('body #login input').attr('readonly', false);
									
									onDuplicateLogin(res);
		                        }
		                    }
		                    else {
		                        $('body #login input').attr('readonly', false);
								// maybe user not found.
								onAuthenFail(err);
		                    }
		                });
		            });
		    }
		    else {
		        server.TokenAuthen(authen.token, function (err, res) {
		            if (!err && res !== null) {
		                console.log("Authen result: ", JSON.stringify(res));
		                if (res.success) {
		                    main.authenUser(server, res.username, res.password, function (err, res) {
		                        if (!err && res !== null) {
		                            if (res.code === 200) {
		                                console.log("Success Authen User...");
		                            }
		                            else {
		                                //<!-- Authen fail.
		                                server.Logout();
		                                location.href = '';

		                                console.error(err, res);
										onDuplicateLogin(err);
		                            }
		                        }
		                        else {
		                            //<!-- Authen fail.
		                            server.Logout();
		                            location.href = '';

		                            console.error(err, res);
									onDuplicateLogin(err);
		                        }
		                    });
		                }
		            }
		        });
		    }
		    });
		
			function onDuplicateLogin(param) {
				navigator.notification.confirm("May be you use this app in other devices \n You want to logout other devices", function (buttonIndex) {
					switch (buttonIndex) {
						case 1:
							break;
						case 2:
                        	  server.kickMeAllSession(param.uid);
							break;
					}
				}, "Duplicated login!", ["Cancle", "OK"]);
			}	
			function onAuthenFail(errMessage) {
				navigator.notification.alert(errMessage, function callback() {}, "Login fail!", "OK");
			}
    </script>
</body>
</html>
