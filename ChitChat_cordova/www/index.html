<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
	<title></title>

	<link href="lib/ionic/css/ionic.css" rel="stylesheet" />
	<link href="css/style.css" rel="stylesheet" />

	<!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
	<link href="css/ionic.app.css" rel="stylesheet" />
	-->
	<!-- ionic/angularjs js -->
	<script src="lib/ionic/js/ionic.bundle.js"></script>

	<!-- cordova script (this will be a 404 during development) -->
	<!--<script src="cordova.js"></script>-->

	<!-- your app's js -->
	<script src="js/app.js"></script>
	<script src="js/controllers.js"></script>
	<script src="js/services.js"></script>
	<script src="js/jquery.min.js"></script>
	<script src="js/require.js" data-main="scripts/appBundle"></script>
	
	<script src="js/template.js"></script>
	
	<script src="scripts/appBundle.js"></script>

</head>
<body ng-app="starter">    
	<script src="js/socket.io.js"></script>
	<script>
	
		var socket = io;
		var main = new Main();
		var server = new ChatServer.ServerImplemented();
		var chatroom = new ChatServer.ChatRoomApiProvider();
		var authen = server.authenData;
/* for test cryptoJs lib.
		main.encodeService("hello", (err, res) => {
		    console.log("encrypt", res);

		    main.decodeService(res, (e, r) => {
		        console.log("decrypt", r);
		    })
		});
*/		
		setTimeout(function(){
			server.init(function () {
				console.log("token: ", authen.token);
				if (!authen.token) {
					$('#splash').css({'display':'none'});
					
					$('body #login #btn-login').click(function (event) {
						console.log('loging A');
						event.preventDefault();						
						$('body #login input').attr('readonly', true);
						email = $('body #login form input[name="email"]').val();
						password = $('body #login form input[name="password"]').val();

						main.getHashService(password, function(err, res) {
						    main.authenUser(server, email, res, function (err, res) {
						        if (!err && res !== null) {
						            if (res.code === 200) {
										console.log("Success Login User...");		
										waitProfile();
						            }
						            else {
										$('body #login input').attr('readonly', false);
										alert("LOGIN FAIL");
						            }
						        }
						        else {
									$('body #login input').attr('readonly', false);
									alert("LOGIN FAIL");
						        }
							});
						});
					});
				}
				else {
					server.TokenAuthen(authen.token, function (err, res) {
						if (!err && res !== null) {
							console.log("Authen result: ", JSON.stringify(res));
							if (res.success) {
							    main.authenUser(server, res.username, res.password, function (err, res) {
							        if (!err && res !== null) {
							            if (res.code === 200) {
							                console.log("Success Authen User...");
											waitProfile();
							            }
							            else {
							                //<!-- Authen fail.
							            }
							        }
							        else {
							            //<!-- Authen fail.
							        }
								});
							}
						}
					});
				}
			})
		}, 1500);
		
		function waitProfile()
		{
			setTimeout(function(){
				console.log('myProfile:::'+main.getDataManager().myProfile['displayname']);
				if(main.getDataManager().myProfile['displayname'] != '')
				{
					console.log('goto group');
					myprofile = main.getDataManager().myProfile;
					$('#login').css('display','none');
					$('.bar-stable').css({'display':''});
					$('#splash').css({'display':'none'});
					location.href = "#/tab/group";											
				}else{
					waitProfile();
				}
			}, 1000);
		}		
	</script>

    <ion-nav-bar class="bar-stable" style="display:none;">
        <ion-nav-back-button>
        </ion-nav-back-button>
    </ion-nav-bar>
    <ion-nav-view></ion-nav-view>
	
	 
	<div id="splash">
		<div class="container">
			<img class="login-logo" src="img/logo-main.png" width="30%" /><br /><br />
			<ion-spinner icon="spiral"></ion-spinner>
		</div>
	</div>
	
	
		
	<div id="send_message">
		<input type="text" name="send_message" />
	</div>
	<div onclick="back()" id="chatroom_back">
		<i class="ion-chevron-left" data-pack="default" data-tags="arrow, left"></i> <span style="font-weight:100;">Back</span>
	</div>

</body>
</html>
